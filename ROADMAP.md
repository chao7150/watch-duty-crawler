# Watch Duty Crawler 開発ロードマップ

このドキュメントは `watch-duty-crawler` プロジェクトの開発マイルストーンとタスクを定義します。

---

## フェーズ1: 基本的なクロール機能の実装

**目標:** 指定されたWebサイトを再帰的にクロールし、ページのコンテンツを取得する基盤を構築する。

-   [x] **プロジェクトセットアップ**
    -   [x] Node.js, TypeScript環境の構築
    -   [x] Playwrightの導入と設定
-   [x] **単一ページの取得**
    -   [x] 指定したURLのHTMLコンテンツを取得する
-   [x] **再帰的クロール**
    -   [x] ページ内のリンクを抽出し、同一ドメイン内の未訪問ページをキューに追加する
    -   [x] 訪問済みURLを記録し、無限ループを防止する
-   [x] **コンテンツ抽出**
    -   [x] `@mozilla/readability` を利用してHTMLから本文を抽出する
    -   [x] 抽出したテキストを整形（不要な改行・空白の削除）する
-   [ ] **クロール対象の管理**
    -   [ ] クロール対象のルートURLを外部ファイル（例: `url-list.json`）で管理する

---

## フェーズ2: クロールの高度化と礼儀作法の実装

**目標:** 対象サーバーへの負荷を考慮し、標準的なクロールルールに従う、より洗練されたクローラーを実装する。

-   [x] **Robots.txtへの対応**
    -   [x] `robots.txt` を取得・解析する
    -   [x] `Disallow` ディレクティブに従い、クロール対象から除外する
-   [ ] **Metaタグへの対応**
    -   [ ] `noindex`, `nofollow` といったmetaタグを解釈し、クロール・インデックス戦略に反映させる
-   [ ] **負荷軽減**
    -   [ ] リクエスト間に適切なウェイト（待機時間）を設ける
    -   [ ] 差分クロールを実装する（`Last-Modified` / `ETag` ヘッダーの活用）
-   [ ] **エラーハンドリング**
    -   [ ] HTTPエラーやタイムアウト発生時のリトライ処理を実装する
    -   [ ] 堅牢なロギング機構を導入する

---

## フェーズ3: コンテンツの構造化と永続化

**目標:** 抽出したコンテンツを意味のある単位に分割し、データベースに保存する。

-   [ ] **データベース設計**
    -   [ ] PostgreSQL + PGroonga を利用したテーブルスキーマを設計する（`pages`, `sites`など）
    -   [ ] Prisma や他のORMを導入し、マイグレーションを設定する
-   [ ] **コンテンツの構造化**
    -   [ ] URLのパターンやキーワードに基づき、ページの役割（`NEWS`, `EPISODE`, `CHARACTER`など）を分類するロジックを実装する
    -   [ ] 本文から適切な長さの抄録を生成する
-   [ ] **データ保存**
    -   [ ] クロールして構造化したデータをデータベースに保存する処理を実装する

---

## フェーズ4: APIサーバーの実装

**目標:** 保存したデータを検索・取得するためのAPIを提供する。

-   [ ] **APIサーバー構築**
    -   [ ] Fastify または他のWebフレームワークを導入する
    -   [ ] `/search` エンドポイントを実装する
-   [ ] **検索機能**
    -   [ ] クエリパラメータ（キーワード, サイト, 役割など）に基づき、PGroongaで全文検索を実行する
    -   [ ] 検索結果をJSON形式で返す
-   [ ] **APIドキュメント**
    -   [ ] Swagger/OpenAPI などを用いてAPI仕様を文書化する

---

## フェーズ5: 運用と自動化

**目標:** クローラーとAPIサーバーを安定して稼働させ、運用を自動化する。

-   [ ] **定期実行**
    -   [ ] `node-cron` などを用いてクロール処理を定期的に実行する
-   [ ] **プロセス管理**
    -   [ ] PM2 や systemd を用いてアプリケーションをデーモン化（常駐化）する
-   [ ] **コンテナ化**
    -   [ ] Dockerfile を作成し、開発・本番環境をコンテナで管理できるようにする
-   [ ] **CI/CD**
    -   [ ] GitHub Actions などを用いて、テストとデプロイのパイプラインを構築する
